logging:
  level:
    ROOT: INFO
    com.vmc: INFO
    org.springframework.cache: TRACE
    #org.springframework.security: DEBUG
    org.redisson: INFO # Logging level for Redisson client; set to DEBUG if Redisson debugging is needed
    org.springframework.transaction: TRACE # Very important for transaction debugging; shows transaction boundaries, commits, rollbacks
    org.springframework.orm.jpa: DEBUG     # Logging for Spring Data JPA; or TRACE if more detailed JPA information is needed
    org.hibernate.SQL: DEBUG             # To see SQL statements executed by Hibernate
    org.hibernate.type.descriptor.sql: TRACE # To see parameters bound to SQL statements by Hibernate
  logback:
    rollingpolicy:
      max-file-size: 100MB
spring:
  application:
    name: api-gateway
  #  config:
  #    import:
  #      - consul:
  messages:
    encoding: 'UTF-8'
    use-code-as-default-message: true
    basename: i18n/labels
    cache-duration: 60   # 60 second, see the ISO 8601 standard
  cloud:
    consul:
      host: localhost # Address of the Consul agent
      port: 8500      # Port of the Consul agent (default is 8500)
      discovery:
        register: true # Enable service discovery with Consul
        instance-id: ${spring.application.name}-${random.value} # Generate a unique instance ID
        health-check-path: /actuator/health # Path for health checks (requires Spring Boot Actuator)
        health-check-interval: 10s
        prefer-ip-address: true # Register service with its IP address instead of hostname (optional)
      config:
        enabled: false # Enable Spring Cloud Consul Config
        prefixes: config # Default prefix for configuration keys in Consul (default is /config)
        default-context: application # Default context for configuration (often 'application')
        profile-separator: ',' # Separator used to combine application name and profile in Consul keys
        format: YAML # Format of the configuration files in Consul (can be YAML or PROPERTIES, default is PROPERTIES)
        watch:
          enabled: true # Enable watching for configuration changes in Consul for dynamic updates
  #  webflux:
  #    base-path: /api/gateway
  lifecycle:
    timeout-per-shutdown-phase: 30s
  security:
    oauth2:
      client:
        provider:
          keycloak:
            issuer-uri: http://localhost:8080/realms/vmc-mes
        registration:
          keycloak:
            provider: keycloak
            client-id: vmc-mes-admin-client
            client-secret: 1zGJS3RaIZpdcEZV4Bmz0Jn86byAfCtS
            authorization-grant-type: authorization_code
            redirect-uri: http://localhost:9000/login/oauth2/code/keycloak
            scope:
              - openid
              - email
              - profile
              - roles
      resourceserver:
        jwt:
          # The URI of the OpenID Connect Provider that will issue ID Tokens and Access Tokens
          issuer-uri: http://localhost:8080/realms/vmc-mes

keycloak:
  client:
    ssl-required: none
    resource: vmc-mes-admin-client
    credentials:
      secret: 1zGJS3RaIZpdcEZV4Bmz0Jn86byAfCtS
    public-client: false
    auth-server-url: http://localhost:8080
    realm: vmc-mes

server:
  port: 9000 # Port the API Gateway will run on
  shutdown: graceful

springdoc:
  swagger-ui:
    path: /swagger-ui.html # Path to access the main Swagger UI page
    urls:
      # Configuration for aggregating Swagger docs from downstream services
      - name: Product Service # Display name for the service in the Swagger UI dropdown
        url: /api/product-service/v1/api-docs # Path where the Gateway exposes the aggregated docs for this service
      - name: Order Service # Display name for the service in the Swagger UI dropdown
        url: /api/order-service/v1/api-docs # Path where the Gateway exposes the aggregated docs for this service
  api-docs:
    path: /api-docs # Path for the Gateway's own API documentation (if any)

# Actuator Endpoints Configuration
management:
  server:
    port: 9001
  health:
    circuitbreakers:
      enabled: true # Include circuit breaker status in the health endpoint
  endpoints:
    web:
      exposure:
        include: "*" # Expose all actuator endpoints over HTTP (use '*' with caution in production)
  endpoint:
    health:
      show-details: always # Always show full details in the /actuator/health endpoint
  metrics:
    distribution:
      percentiles-histogram:
        http:
          server:
            requests: true # Enable histogram metrics for HTTP server requests
  observations:
    key-values:
      application: ${spring.application.name} # Add application name as a default tag for observations/metrics
  tracing:
    enabled: false
    sampling:
      probability: 1.0 # Sample 100% of traces (useful for dev, adjust for production)

# Resilience4j Configuration
resilience4j:
  circuitbreaker:
    configs:
      default: # Default configuration for all circuit breakers unless overridden
        registerHealthIndicator: true # Register a health indicator for this circuit breaker
        slidingWindowType: COUNT_BASED # Use a count-based sliding window
        slidingWindowSize: 10 # Size of the sliding window (number of requests)
        failureRateThreshold: 50 # Percentage of failures to trip the circuit breaker
        waitDurationInOpenState: 5s # Duration the circuit breaker stays open before transitioning to half-open
        permittedNumberOfCallsInHalfOpenState: 3 # Number of permitted calls in the half-open state
        automaticTransitionFromOpenToHalfOpenEnabled: true # Automatically transition from open to half-open
        minimum-number-of-calls: 5 # Minimum number of calls required before calculating the failure rate
  # Resilience4J Timeout Configuration
  timelimiter:
    configs:
      default: # Default configuration for time limiters
        timeout-duration: 3s # Maximum duration allowed for an operation
  # Resilience4J Retry Configuration
  retry:
    configs:
      default: # Default configuration for retries
        max-attempts: 3 # Maximum number of attempts (including the initial call)
        wait-duration: 2s # Wait duration between retry attempts

# Custom Application Properties
app:
  gateway:
    routes: # List of routes to be configured dynamically via Java config
      - id: product_service_route # Unique identifier for the route
        path: /api/product-service/**   # Path predicate to match incoming requests
        uri: lb://product-service # Target service URI (using load balancer 'lb' scheme)
        strip-prefix: 2           # Number of path segments to strip before forwarding (optional, defaults to 0 if omitted)
        circuitBreakerEnabled: true # Enable CB for this route
        circuitBreakerName: productServiceCircuitBreaker # Optional: specific CB name
        tokenRelayEnabled: true # Enable token relay for this route
        metadata:
          service-id: product-service-client-id # <-- REPLACE with actual Keycloak Client ID for Product Service
      - id: order_service_route # Unique identifier for the route
        path: /api/order-service/**   # Path predicate to match incoming requests
        uri: lb://order-service # Target service URI (using load balancer 'lb' scheme)
        strip-prefix: 2           # Number of path segments to strip before forwarding (optional, defaults to 0 if omitted)
        circuitBreakerEnabled: true # Enable CB for this route
        circuitBreakerName: orderServiceCircuitBreaker # Optional: specific CB name
        tokenRelayEnabled: true # Enable token relay for this route
        metadata:
          service-id: order-service-client-id # <-- REPLACE with actual Keycloak Client ID for Product Service
      # --- Add other route definitions here ---
      # - id: order_service_route
      #   path: /order-service/**
      #   uri: lb://order-service
      #   strip-prefix: 1
      # - id: another_service_route
      #   path: /another/**
      #   uri: http://localhost:9090 # Example of a fixed URI
      #   # No strip-prefix here

security:
  cache:
    url-patterns: '/i18n/*,/content/*,/app/*'
    max-age: 86400 # Image cache max-age in second, duration: 86400 (1 day)
  # CORS is only enabled by default with the "dev" profile, so BrowserSync can access the API
  cors:
    allowed-origins: '*' # http://localhost:8780
    allowed-methods: 'POST,OPTIONS'
    allowed-headers: '*'
    exposed-headers: 'Authorization,Link,X-Total-Count,X-Action-Message,X-Action-Params,X-CSRF-TOKEN'
    allow-credentials: true
    max-age: 1800
  authentication:
    jwt:
      # This token must be encoded using Base64 and be at least 256 bits long (you can type openssl rand -base64 64 on your command line to generate a 512 bits one)
      base64-secret: 'ajMywt0FWnZYET/u3Pm309ziD6eXRewGX+QsyHs6/Y4ascWDHAAK46ARsuUZKLcjMQxUa5mQfNTaujgm8Sg4TJh4wKGwwXBAtB2gsEm1TkZuSRo97/BEFIR5rEKefTBf41J4kcU/YndvNFJcMRXkgMoC6fvzjSVYx1fGNYxSJqO+neilVm3uBpQiuhQrhTMmrKZJYa5M9xutWfJsbQ1Tf6IQ6zlRKZqdt8edUD/mOuUwltlyC1UZCyALrcji2vFlgXu+eks6IjBkxlAT3LvwVe5Et4MoNaB+eHetIdL6epigf1nYxmLSPT3rWfQxRRmHAwSQnO+1atAubG/xQqvsTQ=='
    cookie:
      domain-name:
      enable-ssl: false
      http-only: true
      path: '/'
      same-site: 'None'
    public-url-patterns:
      - "/actuator/**"
    signature:
      gateway-shared-secret: "X;=Lcu>6ib6dyzCfAwEqc{--k%)WA,"
    user:
      login-max-attempt-time: 5
      password-max-attempt-time: 5

cache:
  config-type: 'redisson' # redis/redisson/hazelcast
  hazelcast:
    instanceName: 'vcm_mes'
    localIp: '127.0.0.1'
    remoteIp: '127.0.0.1'
    backup-count: 1
    management-center: # Full reference is available at: http://docs.hazelcast.org/docs/management-center/3.9/manual/html/Deploying_and_Starting.html
      enabled: false
      update-interval: 3
      url: http://192.168.2.100:8180/hazelcast-mancenter
  redis:
    mode: 'standalone' # standalone, sentinel
    standalone:
      host: 'localhost'
      port: 6379
      password: 12345678aA@
    sentinel:
      port: 26379
      password:
      master: masterredis
      nodes:
        - localhost
        #- 10.0.0.17
        #- 10.0.0.18
    lettuce-pool:
      shutdown-timeout: 200 #milliseconds
      command-timeout: 200 #milliseconds
      min-idle: 1
      max-idle: 20
      max-wait-millis: 200 #milliseconds
      max-total: 20
    cache-duration: 1440 # thời gian lưu cache (đơn vị phút)
  redisson:
    mode: single #single, sentinel
    clientName: 'redis-client'
    password: 12345678aA@
    subscriptionsPerConnection: 5
    idleConnectionTimeout: 10000
    connectTimeout: 10000
    timeout: 3000
    retryAttempts: 3
    retryInterval: 1500
    threads: 16
    nettyThreads: 32
    transportMode: 'NIO'
    database: 0
    cache-duration: 10 # thời gian lưu cache (đơn vị phút)
    #mode single config
    single:
      address: 'redis://127.0.0.1:6379' #if use ssl, the address should start with rediss://
      subscriptionConnectionMinimumIdleSize: 1
      subscriptionConnectionPoolSize: 50
      connectionMinimumIdleSize: 24
      connectionPoolSize: 64
      dnsMonitoringInterval: 5000
    #mode sentinel config
    sentinel:
      failedSlaveReconnectionInterval: 3000
      failedSlaveCheckInterval: 60000
      subscriptionConnectionMinimumIdleSize: 1
      subscriptionConnectionPoolSize: 50
      slaveConnectionMinimumIdleSize: 24
      slaveConnectionPoolSize: 64
      masterConnectionMinimumIdleSize: 24
      masterConnectionPoolSize: 64
      readMode: 'SLAVE' #SLAVE/MASTER/MASTER_SLAVE
      subscriptionMode: 'SLAVE' #SLAVE/MASTER
      nodes:
        - 'redis://127.0.0.1:26379'
        - 'redis://127.0.0.1:26380'
      masterName: 'masterredis'
      checkSentinelsList: false
  time-to-lives: # time to live in seconds
    default: -1